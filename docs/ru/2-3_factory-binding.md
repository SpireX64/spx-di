# 2.3 Привязка фабрики
Привязка фабрики - это делегирование процесса создания экземпляра на DI контейнер.

Фабрика - это обычная функция, которая возвращает экземпляр нужного типа.

С помощью фабрики, мы объясняем контейнеру то, как экземпляр должен быть создан
и какие зависимости ему для этого нужны.

## Когда использовать?
Привязку фабрики следует использовать, когда возникает один из этих случаев:

1. Значение заранее неизвестно;
2. Создание экземпляра требует предоставить зависимости;
3. Требуется организовать отличный от Singleton жизненный цикл;
4. Требуется отложить создание экземпляра.


То есть, когда для создания экземпляра типа нужны особые условия,
тогда лучше пользовать привязку фабрики.

## Выполнение привязки фабрики
Привязка фабрики выполняется с помощью метода сборщика `bindFactory`:

```ts
declare function bindFactory(
    type: TypeKey, 
    factory: TInstanceFactory,
    lifecycle?: Lifecycle,
    options?: TBindingOptions,
)
```
где,
- `type` - ключ типа, к которому выполняется привязка;
- `factory` - функция-фабрика, описывающая создание экземпляра;
- `lifecycle` - (необяз.) жизненный цикл экземпляра;
- `options` - (необяз.) дополнительные опции привязки.

В отличие от привязки по значению, привязка фабрики
позволяет указать другой тип жизненного цикла.
Если его не указывать, то он будет определен как Singleton.

Функция фабрики должна иметь следующий интерфейс:
```ts
type TInstanceFactory<TypeMap extends object, Type extends keyof TypeMap> =
    (resolver: IDependencyResolver<TypeMap>) => TypeMap[Type]
```

То есть она принимает первым параметром `resolver`,
который позволяет предоставить необходимые зависимости
в процессе ее работы.

## Пример использования
Нужно предоставить сервис для работы с OAuth-авторизацией.
Он требует API-ключ для работы.
Во время работы приложения, сервис может быть не использован ни разу.

```ts
const Types = {
  OAuthApiKey: Symbol('OAuthApiKey'),
  OAuthService: Symbol('OAuthService'),
}

type TypeMap = {
  [Types.OAuthApiKey]: string
  [Types.OAuthService]: IOAuthService
}

const container = DIContainer.builder<TypeMap>()
  // Привязываем API-ключ сервиса
  .bindInstance(Types.OAuthApiKey, 'NMd45oJK-LNfl7246-SA474rfSF')
    
  // Привязываем OAuth-сервис с помощью фабрики
  .bindFactory(
    Types.OAuthService,
    resolver => new OAuthServiceImpl( // Создаем экземпляр с помощью конструтора
      resolver.get(Types.OAuthApiKey), // Предоставляем API-ключ
    ),
    Lifecycle.LazySingleton, // Разрешаем создавать только по необходимости
  )
  .build()
```

В результате экземпляр `OAuthService` будет создан не сразу,
а только после первого его запроса из контейнера.
Для создания экземпляра будет использована фабрика,
которая создаст экземпляр с помощью его конструктора
и предоставляет необходимый для работы API-ключ.
